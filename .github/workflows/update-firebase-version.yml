name: Update Firebase Version

on:
  release:
    types: [published]

jobs:
  update-version:
    runs-on: ubuntu-latest
    steps:
      - name: Extract version from tag
        id: version
        run: |
          # Remove 'v' prefix from tag name (v1.4.3 -> 1.4.3)
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Updating Firebase to version: $VERSION"

      - name: Update Firebase latestVersion
        run: |
          curl -X PUT \
            "https://pisscord-edbca-default-rtdb.firebaseio.com/system/latestVersion.json?auth=${{ secrets.FIREBASE_DATABASE_SECRET }}" \
            -d "\"${{ steps.version.outputs.version }}\""
          echo "Firebase latestVersion updated to ${{ steps.version.outputs.version }}"

      - name: Update Firebase release notes
        env:
          FIREBASE_SECRET: ${{ secrets.FIREBASE_DATABASE_SECRET }}
          VERSION: ${{ steps.version.outputs.version }}
          RELEASE_BODY: ${{ github.event.release.body }}
        run: |
          DOWNLOAD_URL="https://github.com/jamditis/pisscord/releases/download/v${VERSION}/Pisscord.Setup.${VERSION}.exe"
          TIMESTAMP=$(date +%s000)

          # Build JSON payload with jq for safe escaping
          PAYLOAD=$(jq -n \
            --arg version "$VERSION" \
            --arg notes "$RELEASE_BODY" \
            --arg url "$DOWNLOAD_URL" \
            --argjson ts "$TIMESTAMP" \
            '{version: $version, releaseNotes: $notes, downloadUrl: $url, lastUpdated: $ts}')

          curl -X PUT \
            "https://pisscord-edbca-default-rtdb.firebaseio.com/system/releaseNotes.json?auth=${FIREBASE_SECRET}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"
          echo "Firebase release notes updated for v${VERSION}"
